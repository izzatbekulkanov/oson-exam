{% extends 'base.html' %}

{% load static %}
{% load sass_tags %}

{% block css %}
    <!-- Plugins css start-->
    <!-- Plugins css Ends-->
{% endblock %}

{% block content %}

    <div class="page-body">
        {% include "layout/breadcrumb.html" %}
        <div class="container-fluid">
            <div class="row">
                {% include "applications/library/acceptBook/components/accept-book-list.html" %}
            </div>
        </div>
    </div>

    <div class="modal fade open-accept-book-modal" tabindex="-1" aria-labelledby="myLargeModalLabel" aria-hidden="true"
         style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-body dark-modal">
                    <div class="card">
                        <div class="table-responsive signal-table">
                            <table class="table table-hover" id="accept-book-table">
                                <thead>
                                <tr>
                                    <th scope="col">TR</th>
                                    <th scope="col">Kitob nomi</th>
                                    <th scope="col">Kitob turi</th>
                                    <th scope="col">BBK</th>
                                    <th scope="col">Kitob tili</th>
                                    <th scope="col">Inventar raqam</th>
                                    <th scope="col">Tanlash</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <th scope="row">1</th>
                                    <td>Astrid: NE Shared managed</td>
                                    <td>Medium</td>
                                    <td>Triaged</td>
                                    <td>0.33</td>
                                    <td>
                                        <div class="form-check checkbox-width checkbox checkbox-primary mb-0">
                                            <input class="from-check-input" id="checkbox-task-1" type="checkbox"
                                                   checked="">
                                            <label class="form-check-label" for="checkbox-task-1"> </label>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Yopish</button>
                    <button class="btn btn-success" type="button" id="accept-save-book-to-library">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scriptcontent %}

    <script src="{% static 'assets/js/notify/notify-script.js' %}"></script>
    <script src="{% static 'assets/js/notify/bootstrap-notify.min.js' %}"></script>
    <script src="{% static 'assets/js/notify/custom-notify.js' %}"></script>



    <script>
        $(document).ready(function () {
            // Dastlabki ma'lumotlarni olish
            fetchData("{% url 'get_sent_books_by_bbk' %}", displayBookList);

            // Modal ochish tugmasi bosilganda
            $(".open-accept-book-modal").on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var date = button.data('date');
                fetchData("{% url 'get_sent_books_by_date' %}", displayModalTable, {date: date});
            });

            // Saqlash tugmasiga bosilganda tanlangan kitob nusxalarini yuborish
            $(document).on('click', '#accept-save-book-to-library', function () {
                var selectedCopies = getSelectedCopies();
                if (selectedCopies.length > 0) {
                    saveBookCopies("{% url 'accept_book_copies' %}", selectedCopies);
                }
            });
        });


        function fetchData(url, callback, params = {}) {
            $.ajax({
                url: url,
                type: "GET",
                data: params,
                dataType: "json",
                success: function (response) {
                    callback(response);
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching data:", error);
                }
            });
        }

        function displayBookList(response) {
            var bookCopyList = $("#book-copy-list");
            var index = 0;

            console.log(response)

            bookCopyList.empty();

            $.each(response, function (date, copies) {
                var rowHtml = '<tr>' +
                    '<td class="border-icon facebook col-1">' + (index + 1) + '</td>' +
                    '<td class="col-6">' + date + '</td>' +
                    '<td class="col-5">' + copies.length + '</td>' +
                    '<td class="col-1">' +
                    '<button class="btn badge-light-primary" data-date="' + date + '" data-bs-toggle="modal" data-bs-target=".open-accept-book-modal">Ko\'rish</button>' +
                    '</td>' +
                    '</tr>';
                bookCopyList.append(rowHtml);
                index++;
            });
        }
        

        function displayModalTable(data) {
            var modalBody = $(".open-accept-book-modal .modal-body");
            modalBody.empty();

            var tableHtml = '<table class="table table-hover" id="accept-book-table">' +
                '<thead>' +
                '<tr>' +
                '<th scope="col">TR</th>' +
                '<th scope="col">Kitob nomi</th>' +
                '<th scope="col">Kitob turi</th>' +
                '<th scope="col">BBK</th>' +
                '<th scope="col">Til</th>' +
                '<th scope="col">Inventar raqam</th>' +
                '<th scope="col">Tanlash</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';

            $.each(data, function (index, copy) {
                tableHtml += '<tr>' +
                    '<th scope="row">' + (index + 1) + '</th>' +
                    '<td>' + copy.original_book.title + '</td>' +
                    '<td>' + copy.original_book.bookType.name + '</td>' +
                    '<td>' + copy.original_book.BBK.name + '</td>' +
                    '<td>' + copy.original_book.language + '</td>' +
                    '<td>' + copy.inventory_number + '</td>' +
                    '<td>' +
                    '<div class="form-check checkbox-width checkbox checkbox-primary mb-0">' +
                    '<input class="form-check-input" id="checkbox-task-' + (index + 1) + '" type="checkbox" value="' + copy.inventory_number + '">' +
                    '<label class="form-check-label" for="checkbox-task-' + (index + 1) + '"> </label>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
            });

            modalBody.append(tableHtml);
        }

        function getSelectedCopies() {
            var selectedCopies = [];
            $("#accept-book-table input[type='checkbox']:checked").each(function () {
                selectedCopies.push($(this).val());
            });
            return selectedCopies;
        }

        function saveBookCopies(url, copies) {
            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify({copies: copies}),
                contentType: "application/json",
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function (response) {
                    console.log("Books accepted:", response);
                    fetchData("{% url 'get_sent_books_by_bbk' %}", displayBookList);
                    $('.open-accept-book-modal').modal('hide');
                },
                error: function (xhr, status, error) {
                    console.error("Error accepting book copies:", error);
                }
            });
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <!-- Plugins JS start-->
    <script src="{% static 'assets/js/tooltip-init.js' %}"></script>
    <!-- Plugins JS Ends-->
{% endblock %}