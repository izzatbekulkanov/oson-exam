{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
{% load i18n %}
{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/animate.scss' %}">
<!-- Plugins css Ends-->
<style>
    .input-image-class {
    display: grid;
    place-content: center;
    grid-gap: 5px;
    margin: 0;
    podding: 0;
    box-sizing: border-box;
    }
    .input-image-i {
    display: none;
    }
    .input-image-class {
    padding: 15px;
    border: 2px dotted #7e57c2;
    border-radius: 5px;
    color: #7e57c2;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    }
    .input-image-class:hover {
    background-color: #ede7f6;
    }
    ion-icon {
    font-size: 24px;
    }
    .input-span-class {
    max-width: 100%;
    font-family: sans-serif;
    font-size: 20px;
    text-align: center;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    }
    input[value=""], input:not([value]) {
        border: 1px solid red;
    }
</style>
    <!-- CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.css" />
{% endblock %}
{% block content %}
<div class="page-body">
    <div class="container-fluid">
        {% include "layout/breadcrumb.html" %}
        <div class="row project-cards">
            {% include "applications/library/category/components/update-list-1.html" %}
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="tab-content" id="top-tabContent">
                            {% include "applications/library/category/components/update-list-2.html" %}
                            {% include "applications/library/category/components/update-list-3.html" %}
                            {% include "applications/library/category/components/update-list-4.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="category-library" tabindex="-1" aria-labelledby="category-library" aria-hidden="true"
    style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="modal-toggle-wrapper">
                    <div class="card-body">
                        <h4 class="mb-3 mt-1 f-w-500 mb-0 f-22">{% trans 'Enter the type of book' %}<span> <img src="{% static 'assets/images/dashboard-3/hand.svg' %}" alt="hand vector"></span></h4>
                    </div>
                    <form method="post" enctype="multipart/form-data" id="book-type-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="name" class="form-label">{% trans 'Title' %}:</label>
                            <input type="text" class="form-control" id="name" name="name" required placeholder="{% trans 'Enter the name of the book type' %}">
                        </div>
                        <label for="input-image" id="input-image-id" class="input-image-class m-5">
                            <ion-icon name="cloud-upload-outline"></ion-icon>
                            <span id="input-image-span"
                                class="input-span-class"> {% trans 'Upload a book type image' %}</span>
                            <input id="input-image" class="input-image-i" type="file" name="image">
                        </label>
                        <div class="mb-1 form-check mt-10">
                            <input type="checkbox" class="form-check-input" id="is_active" name="is_active"
                                checked>
                            <label class="form-check-label" for="is_active">{% trans 'active' %}</label>
                        </div>
                    </form>
                </div>
                <button class="btn bg-primary d-flex align-items-center gap-2 text-light ms-auto" type="button"
                    id="save-book-type">{% trans 'save' %}
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="bbk-library" tabindex="-1" aria-labelledby="bbk-library" aria-hidden="true"
    style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="modal-toggle-wrapper">
                    <div class="card-body">

                        <h4 class="mb-3 mt-1 f-w-500 mb-0 f-22">BBK kiritish<span> <img src="{% static 'assets/images/dashboard-3/hand.svg' %}" alt="hand vector"></span></h4>
                    </div>
                    <form id="bbk-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="bbk-name" class="form-label">BBK kodi:</label>
                            <input type="text" class="form-control" id="bbk-name" name="name" required
                                placeholder="BBK nomini kiriting">
                        </div>
                        <div class="mb-3">
                            <label for="bbk-title" class="form-label">BBK nomi:</label>
                            <input type="text" class="form-control" id="bbk-title" name="title"
                                placeholder="BBK kalit so'zini kiriting" required>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="bbk-is-active" name="is_active"
                                checked>
                            <label class="form-check-label" for="bbk-is-active">Aktiv</label>
                        </div>
                    </form>
                    <button class="btn bg-primary d-flex align-items-center gap-2 text-light ms-auto" type="button"
                        id="save-bbk-button">
                        {% trans 'Save' %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" class="feather feather-arrow-right">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scriptcontent %}

    <script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var topHomeTab = document.getElementById("top-home-tab");
        var profileTopTab = document.getElementById("profile-top-tab");
        var addCategoryBtn = document.getElementById("add-category");
        var addBbkBtn = document.getElementById("add-bbk");

        topHomeTab.addEventListener("click", function () {
            addCategoryBtn.style.display = "inline-block";
            addBbkBtn.style.display = "none";
        });

        profileTopTab.addEventListener("click", function () {
            addCategoryBtn.style.display = "none";
            addBbkBtn.style.display = "inline-block";
        });
    });
</script>
<script>
    document.getElementById("input-image-id").addEventListener("change", (e) => {
        document.getElementById("input-image-span").innerText = e.target.files[0].name;
    });
</script>

<script>
    // Modal oynani yopish funksiyasi

    // Yangi kitob turi yaratish uchun funksiya
    function createBookType() {
        // Modal oynani ochish
        $('#category-library').modal('show');
    }

    // Modal oynani yopish funksiyasi
    function hideModal() {
        $('#category-library').modal('hide');
    }

    // Saqlash tugmasini bosganda ishga tushiriladigan funksiya
    $('#save-book-type').click(function() {
        // Yangi kitob turi ma'lumotlarini olish
        var name = $('#name').val().trim(); // Kitob turi nomi
        var image = $('#input-image').prop('files')[0]; // Kitob turining rasmi
        var isActive = $('#is_active').prop('checked'); // Kitob turining holati (aktivmi?)

        // Ma'lumotlarni tekshiramiz
        if (!name) {
            alert('{% trans 'Name is required.' %}');
            return;
        }

        // Yaratilayotgan form ma'lumotlarini yuborish uchun FormData obyektini yaratish
        var formData = new FormData();
        formData.append('name', name);
        formData.append('image', image);
        formData.append('is_active', isActive);

        // Ma'lumotlarni POST so'rov orqali yuborish
        $.ajax({
            type: 'POST',
            url: '{% url 'create_book_type' %}', // Sizning server tomonidagi URL manzilingiz
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // Muaffaqiyatli yaratilganlik haqidagi habarni chiqarish

                console.log(response)
                hideTypeModal(); // Modalni yopish
                var myNotify = new Notify({
                    position: "right bottom",
                    status: 'success',
                    title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                    text: response.message,
                    effect: 'slide',
                    type: 'outline'
                });
            },
            error: function(xhr, status, error) {
                // Xatolik sodir bo'lganda, foydalanuvchiga xabar chiqarish
                    var myNotify = new Notify({
                        position: "right bottom",
                        status: 'error',
                        title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                        text: response.message,
                        autotimeout: 3000,
                        speed: 200,
                        autoclose: true,
                        effect: 'slide',
                        type: 'outline'
                    });
            }
        });
    });
    // Rasmlar yuklandikda fayl nomini o'zgartirish
    document.getElementById("input-image-id").addEventListener("change", (e) => {
        document.getElementById("input-image-span").innerText = e.target.files[0].name;
    });
    function hideTypeModal(name) {
    $('#category-library').modal('hide');
    // Formani tozalash
    $('#book-type-form')[0].reset(); // Formani tozalash
    $('#input-image-span').text('{% trans "Upload a book type image" %}');
}
</script>
<script>
    document.getElementById('save-bbk-button').addEventListener('click', function () {
        var bbkName = document.getElementById('bbk-name').value;
        var bbkTitle = document.getElementById('bbk-title').value;
        var bbkIsActive = document.getElementById('bbk-is-active').checked;

        var data = {
            name: bbkName,
            title: bbkTitle,
            is_active: bbkIsActive
        };

        $.ajax({
            url: '{% url "create_bbk" %}',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: JSON.stringify(data),
            success: function (response) {
                fetchBbkAll();
                var myNotify = new Notify({
                    position: "right bottom",
                    status: 'success',
                    title: "{% trans 'library' %}",
                    text: response.message,
                    autotimeout: 3000,
                    speed: 200,
                    autoclose: true,
                    effect: 'slide',
                    type: 'outline'
                });
                hideBbkModal();
            },
            error: function (xhr, status, error) {
                var myNotify = new Notify({
                    position: "right bottom",
                    status: 'error',
                    title: "{% trans 'library' %}",
                    text: xhr.responseText,
                    autotimeout: 3000,
                    speed: 200,
                    autoclose: true,
                    effect: 'slide',
                    type: 'outline'
                });
                hideBbkModal();
            }
        });
    });

    function hideBbkModal() {
        $('#bbk-library').modal('hide');
        // Formani tozalash
        $('#bbk-form')[0].reset(); // Formani tozalash
    }
</script>
<script>
    // AJAX so'rovini yuborish uchun funktsiya
    function fetchBookTypes() {
        fetch('{% url "get_all_book_types" %}')
            .then(response => response.json())
            .then(data => {
                // Ma'lumotlarni jadvalga qo'yish
                const tableBody = document.querySelector('#book-type-table tbody');
                tableBody.innerHTML = ''; // Eski ma'lumotlarni o'chirish

                data.book_types.forEach((bookType, index) => {
                    const row = `
                                <tr>
                                    <th scope="row">${index + 1}</th>
                                    <td>${bookType.name}</td>
                                    <td>${bookType.is_active ? 'Aktiv' : 'Noaktiv'}</td>
                                    <td> <b>${bookType.total_books} </b> <i>nomda</i> / <b>${bookType.total_book_copies} </b> <i>nusxada</i></td>
                                    <td>${bookType.created_at}</td>
                                    <td>
                                        <a href="">Tahrirlash</a>
                                    </td>
                                </tr>
                            `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => console.error('Xatolik:', error));
    }
</script>
<script>
function fetchBbkAll() {
    // get_all_bbks funksiyasidan ma'lumotlarni olish
    fetch('{% url "get_all_bbks" %}')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            var bbks = data.bbks;
            var tableBody = document.getElementById('bbk-table-body');
            tableBody.innerHTML = ''

            // Har bir BBK obyektining ma'lumotlarini jadvalga qo'shish
            bbks.forEach(function (bbk, index) {
                var row = `<tr>
                    <th scope="row">${index + 1}</th>
                    <td class="col-2">
                        <input type="number" value="${bbk.title || ''}" class="bbk-title form-control border-${index % 2 + 1}" disabled>
                    </td>
                    <td class="col-5">
                        <input type="text" value="${bbk.name || ''}" class="bbk-name w-100 form-control border-${index % 2 + 1}" disabled>
                    </td>
                    <td><b>${bbk.book_count}</b> <i>nomda</i> / <b>${bbk.book_copy_count}</b> <i>nusxada</i></td>
                    <td>${bbk.created_at}</td>
                    <td class="text-center">
                        <button onclick="editBbk(${bbk.id}, ${index})" class="btn btn-sm"><i class="fa fa-edit"></i></button>
                    </td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error('Error fetching BBKs:', error);
        });
}
</script>
<script>
    async function editBbk(bbkId, index) {
        var bbkRow = document.querySelector(`#bbk-table-body tr:nth-child(${index + 1})`);
        var bbkNameInput = bbkRow.querySelector('.bbk-name');
        var bbkTitleInput = bbkRow.querySelector('.bbk-title');

        bbkNameInput.disabled = false;
        bbkTitleInput.disabled = false;

        // "Tahrirlash" tugmasini "Saqlash" tugmasiga o'zgartiramiz
        var editLink = bbkRow.querySelector('button');
        editLink.innerHTML = '<i class="fa fa-save btn btn-air-info "></i> <button class="btn btn-air-danger"><i class="icofont icofont-ui-delete"></i></i></button> ';
        editLink.setAttribute('onclick', `saveBbk(${bbkId}, ${index})`);

        // Tr birinchisiga scroll qilish
        bbkRow.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
    }

    async function saveBbk(bbkId, index) {
    var bbkRow = document.querySelector(`#bbk-table-body tr:nth-child(${index + 1})`);
    var bbkNameInput = bbkRow.querySelector('.bbk-name');
    var bbkTitleInput = bbkRow.querySelector('.bbk-title');

    var bbkName = bbkNameInput.value;
    var bbkTitle = bbkTitleInput.value;

    // BBKni tahrirlash uchun yangi ma'lumotlar bilan JSON formatida AJAX so'rovi jo'natish
    var requestData = {
        id: bbkId,
        name: bbkName,
        title: bbkTitle
    };

    try {
        $.ajax({
            url: "{% url 'update_bbk' %}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(requestData),
            success: function (data) {
                // Ma'lumotlar muvaffaqiyatli yangilandi

                // Saqlash tugmasini "Tahrirlash" tugmasiga qaytarish
                var editLink = bbkRow.querySelector('button');
                editLink.innerHTML = '<i class="fa fa-save"></i>';
                editLink.setAttribute('onclick', `editBbk(${bbkId}, ${index})`);
                fetchBbkAll();
                var myNotify = new Notify({
                    position: "right bottom",
                    status: 'success',
                    title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                    text: data.message,
                    autotimeout: 3000,
                    speed: 200,
                    autoclose: true,
                    effect: 'slide',
                    type: 'outline'
                });

                // Inputlarni qayta disabl qilish
                bbkNameInput.disabled = true;
                bbkTitleInput.disabled = true;
            },
            error: function (xhr, status, error) {
                var myNotify = new Notify({
                    position: "right bottom",
                    status: 'error',
                    title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                    text: error,
                    autotimeout: 3000,
                    speed: 200,
                    autoclose: true,
                    effect: 'slide',
                    type: 'outline'
                });
                fetchBbkAll();
            }
        });
    } catch (error) {
        var myNotify = new Notify({
                        position: "right bottom",
                        status: 'error',
                        title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                        text: error.message,
                        autotimeout: 3000,
                        speed: 200,
                        autoclose: true,
                        effect: 'slide',
                        type: 'outline'
                    });
        fetchBbkAll();
    }
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sahifa yuklandiÄŸida ma'lumotlarni o'qish
        fetchBbkAll();
        fetchBookTypes();
    });
</script>


    <!-- Plugins JS start-->
    <script src="{% static 'assets/js/typeahead/handlebars.js' %}"></script>
    <script src="{% static 'assets/js/typeahead/typeahead.bundle.js' %}"></script>
    <script src="{% static 'assets/js/typeahead/typeahead.custom.js' %}"></script>
    <script src="{% static 'assets/js/typeahead-search/handlebars.js' %}"></script>
    <script src="{% static 'assets/js/typeahead-search/typeahead-custom.js' %}"></script>
    <script src="{% static 'assets/js/tooltip-init.js' %}"></script>


{% endblock %}