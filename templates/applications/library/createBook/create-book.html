{% extends 'base.html' %}
{% load i18n %}

{% load static %}
{% load sass_tags %}

{% block css %}
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/owlcarousel.scss' %}">
    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/date-picker.scss' %}">
    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/dropzone.scss' %}">
    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/select2.scss' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/scss/customScss/createBook.css' %}">


    <!-- Plugins css Ends-->

    <style>

        .file-upload {
            background-color: #ffffff;
            width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .file-upload-btn {
            width: 100%;
            margin: 0;
            color: #fff;
            background: #1FB264;
            border: none;
            padding: 10px;
            border-radius: 4px;
            border-bottom: 4px solid #15824B;
            transition: all .2s ease;
            outline: none;
            text-transform: uppercase;
            font-weight: 700;
        }

        .file-upload-btn:hover {
            background: #1AA059;
            color: #ffffff;
            transition: all .2s ease;
            cursor: pointer;
        }

        .file-upload-btn:active {
            border: 0;
            transition: all .2s ease;
        }

        .file-upload-content {
            display: none;
            text-align: center;
        }

        .file-upload-input {
            position: absolute;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            outline: none;
            opacity: 0;
            cursor: pointer;
        }

        .image-upload-wrap {
            margin-top: 20px;
            border: 4px dashed #1FB264;
            position: relative;
        }

        .image-dropping,
        .image-upload-wrap:hover {
            background-color: #1FB264;
            border: 4px dashed #ffffff;
        }

        .image-title-wrap {
            padding: 0 15px 15px 15px;
            color: #222;
        }

        .drag-text {
            text-align: center;
        }

        .drag-text h3 {
            font-weight: 100;
            text-transform: uppercase;
            color: #15824B;
            padding: 60px 0;
        }

        .file-upload-image {
            max-height: 200px;
            max-width: 200px;
            margin: auto;
            padding: 20px;
        }

        .remove-image {
            width: 200px;
            margin: 0;
            color: #fff;
            background: #cd4535;
            border: none;
            padding: 10px;
            border-radius: 4px;
            border-bottom: 4px solid #b02818;
            transition: all .2s ease;
            outline: none;
            text-transform: uppercase;
            font-weight: 700;
        }

        .remove-image:hover {
            background: #c13b2a;
            color: #ffffff;
            transition: all .2s ease;
            cursor: pointer;
        }

        .remove-image:active {
            border: 0;
            transition: all .2s ease;
        }

        /* Bootstrap stil kodlari */
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .custom-file-input::before {
            content: 'Fayl tanlash';
            display: inline-block;
            background: #1FB264;
            color: white;
            padding: 8px 20px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            text-transform: uppercase;
            border: 2px solid #15824B; /* Border qo'shish */
            border-radius: 4px;
        }

        .custom-file-input:hover::before {
            background: #1AA059;
        }

        .custom-file-input:active::before {
            background: #15824B;
        }

        .custom-file-input:focus::before {
            box-shadow: 0 0 0 0.2rem rgba(31, 178, 100, 0.25);
        }

        .container {
            background-color: #ffffff; /* Containerning fon rangi */
            padding: 20px; /* Containerning qoplamasi */
            border: 4px dashed #1FB264; /* Containerga border qo'shish */
            border-radius: 8px; /* Containerning radiusi */
        }

        /* Yuqoridagi kodingizni CSS kodlari shu joyda qo'shing */

    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.css"/>
{% endblock %}

{% block content %}

    <div class="page-body">
        <div class="container-fluid">
            {% include "layout/breadcrumb.html" %}

            {% include "applications/library/createBook/componenets/create-book.html" %}

        </div>
    </div>

{% endblock %}

{% block scriptcontent %}
    <script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>

    <script>
        // Kitoblarni AJAX orqali yuklash funksiyasi
        function loadRecentlyAddedBooks() {
            $.ajax({
                url: '{% url "get_recently_added_books" %}', // Kitoblarni olish uchun AJAX so'rov URL manzili
                type: 'GET', // So'rov turi (GET)
                success: function (data) {
                    // Ma'lumotlar muvaffaqiyatli olinganda funksiyani chaqirish
                    displayBooks(data.recently_added_books);
                },
                error: function (xhr, status, error) {
                    // Serverda xatolik sodir bo'lganida xatoni konsolga chiqarish
                    console.error('Serverda xatolik sodir bo\'ldi:', error);
                }
            });
        }

        // Kitoblarni ko'rsatish funksiyasi
        function displayBooks(books) {
            console.log(books)
            var carousel = $('#owl-carousel-13');
            carousel.html(''); // Carouselni tozalash

            books.forEach(function (book) {
                var item = $('<div class="item"></div>'); // Carousel itemini yaratish
                var card = $('<div class="item"></div>'); // Card elementini yaratish
                var productBox = $('<div class="product-box row"></div>'); // Product box elementini yaratish

                var bookDetails = $(`
                    <div class="component d-flex justify-content-center">
                        <ul class="align list-unstyled">
                            <li class="col-xs-12 col-sm-6 col-md-4">
                                <figure class='book border-right'>
                    
                                    <ul class='hardcover_front border-right border-dark'>
                                        <li>
                                            <div class="coverDesign text-center p-0">
                                                <img class="image-dropping" src="${book.image}" alt="">
                                            </div>
                                        </li>
                                        <li></li>
                                    </ul>
                                    <ul class='page'>
                                        <li></li>
                                        <li>
                                            <a class="btn" href="#">Ko'rish</a>
                                        </li>
                                        <li></li>
                                        <li></li>
                                        <li></li>
                                    </ul>
                                    <ul class='hardcover_back'>
                                        <li></li>
                                        <li></li>
                                    </ul>
                                    <ul class='book_spine'>
                                        <li></li>
                                        <li></li>
                                    </ul>
                                    <figcaption>
                                        <h1>${book.title}</h1>
                                        <span>${book.author}</span>
                                        <p>${book.annotation}</p>
                                    </figcaption>
                                </figure>
                            </li>
                        </ul>
                    </div>`);
                // Yuklanayotgan elementlarni yaratilgan product boxga qo'shish
                productBox.append(bookDetails);
                {#productBox.append(productDetails);#}

                // Card elementiga product boxni qo'shish
                card.append(productBox);

                // Carousel itemiga card elementini qo'shish
                item.append(card);

                // Carouselga carousel itemini qo'shish
                carousel.append(item);
            });

            // Avvalgi carouselni o'chirish
            carousel.owlCarousel('destroy');

            // Carouselni boshlash
            carousel.owlCarousel({
                loop: false, // Cheksiz aylanish yo'q
                margin: 30, // Elementlar orasidagi masofa
                nav: true, // Navigatsiya tugmalari
                autoplay: true, // Avtomatik aylanish
                autoplayTimeout: 3000, // Avtomatik aylanish intervali
                autoplayHoverPause: true, // Hover qilinganda aylanishni to'xtatish
                dots: true, // Navigatsiya nuqtalari
                lazyLoad: true, // Sekin yuklash
                navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"], // Navigatsiya tugmalari matni
                responsive: { // Javob beruvchi konfiguratsiya
                    0: {
                        items: 1 // 0pxdan yuqori ekran kengligi uchun 1ta element
                    },
                    600: {
                        items: 2 // 600pxdan yuqori ekran kengligi uchun 2ta element
                    },
                    1000: {
                        items: 3 // 1000pxdan yuqori ekran kengligi uchun 3ta element
                    },
                    1361: {
                        items: 3 // 1361pxdan yuqori ekran kengligi uchun 3ta element
                    },
                    1900: {
                        items: 4 // 1900pxdan yuqori ekran kengligi uchun 4ta element
                    }
                }
            });
        }

        // Sahifa yuklanganda kitoblarni o'qish uchun AJAX so'rovini yuborish
        document.addEventListener('DOMContentLoaded', function () {
            loadRecentlyAddedBooks();
        });
    </script>

    <!-- Kitob saqlash uchun funksiya -->
    <script>
        $(document).ready(function () {
            $('#saveBook').click(function () {
                // Formdan ma'lumotlarni olish
                var title = $('#title').val();
                var authorCode = $('#authorCode').val();
                var authors = $('#authors').val();
                var page = $('#page').val();
                var adad = $('#adad').val();
                var language = $('#language').val();
                var publisher_city = $('#publisher_city').val();
                var publication_year = $('#publication_year').val();
                var publisher = $('#publisher').val();
                var isbn = $('#isbn').val();
                var inventar_seriya = $('#inventar_seriya').val();
                var quantity = $('#quantity').val();
                var annotation = $('#annotation').val();
                var image = $('#image')[0].files[0];
                var file = $('#customFile')[0].files[0];
                var category_book = $('#book-type-book').val();
                var bbk_book = $('#bbk-book').val();

                // Ajax so'rovi uchun malumotlarni yuborish
                sendFormDataToServer(title, authorCode, authors, page, adad, language, publisher_city, publication_year, publisher, isbn, inventar_seriya, quantity, annotation, category_book, bbk_book, image, file);
            });
        });

        // Ajax so'rovi uchun malumotlarni yuborish funksiyasi
        function sendFormDataToServer(title, authorCode, authors, page, adad, language, publisher_city, publication_year, publisher, isbn, inventar_seriya, quantity, annotation, category_book, bbk_book, image, file) {
            // CSRF token
            var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();

            // FormData obyektini yaratish
            var formData = new FormData();
            formData.append('title', title);
            formData.append('authors', authors);
            formData.append('authorCode', authorCode);
            formData.append('page', page);
            formData.append('adad', adad);
            formData.append('language', language);
            formData.append('publisher_city', publisher_city);
            formData.append('publication_year', publication_year);
            formData.append('publisher', publisher);
            formData.append('isbn', isbn);
            formData.append('inventar_seriya', inventar_seriya);
            formData.append('quantity', quantity);
            formData.append('annotation', annotation);
            formData.append('category_book', category_book);
            formData.append('bbk_book', bbk_book);
            formData.append('csrfmiddlewaretoken', csrf_token);

            // Fayllarni qo'shish (agar mavjud bo'lsa)
            if (image) {
                formData.append('image', image);
            }
            if (file) {
                formData.append('file', file);
            }

            // Ajax so'rovi
            $.ajax({
                url: '{% url "save_book" %}', // Kitobni saqlash uchun URL manzili
                type: 'POST', // So'rov turi (POST)
                data: formData,
                processData: false, // Ma'lumotlarni o'zgartirmaslik
                contentType: false, // Kontent turini aniqlamaslik
                success: function (response) {
                    if (response.success) {
                        var myNotify = new Notify({
                            position: "right bottom",
                            status: 'success',
                            title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                            text: response.message,
                            autotimeout: 3000,
                            speed: 200,
                            autoclose: true,
                            effect: 'slide',
                            type: 'outline'
                        });
                        loadRecentlyAddedBooks();

                        // 5 soniya keyin sahifani yangilash
                        setTimeout(function () {
                            window.location.reload();
                        }, 3000);
                    } else {
                        var myNotify = new Notify({
                            position: "right bottom",
                            status: 'error',
                            title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                            text: response.message,
                            autotimeout: 3000,
                            speed: 200,
                            autoclose: true,
                            effect: 'slide',
                            type: 'outline'
                        });
                        loadRecentlyAddedBooks();
                    }
                },
                error: function (xhr, status, error) {
                    var myNotify = new Notify({
                        position: "right bottom",
                        status: 'error',
                        title: "{% trans 'library' %}", // Xabarni response.message orqali olish
                        text: 'Xatolik yuz berdi: ' + error, // Xatolikni olish
                        autotimeout: 3000,
                        speed: 200,
                        autoclose: true,
                        effect: 'slide',
                        type: 'outline'
                    });
                    loadRecentlyAddedBooks();
                }
            });
        }
    </script>

    <!-- Rasm yuklash uchun funksiya -->
    <script>
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('.image-upload-wrap').hide(); // Rasm yuklash elementini yashirish
                    $('.file-upload-image').attr('src', e.target.result); // Yuklangan rasmni ko'rsatish
                    $('.file-upload-content').show(); // Rasm yuklangan kontentni ko'rsatish
                    $('.image-title').html(input.files[0].name); // Rasm nomini ko'rsatish
                };

                reader.readAsDataURL(input.files[0]); // Faylni o'qish
            } else {
                removeUpload(); // Rasm yuklanmagan bo'lsa yuklashni tozalash
            }
        }

        function removeUpload() {
            $('.file-upload-input').replaceWith($('.file-upload-input').clone()); // Fayl yuklash inputini qayta yaratish
            $('.file-upload-content').hide(); // Fayl yuklangan kontentni yashirish
            $('.image-upload-wrap').show(); // Rasm yuklash elementini ko'rsatish
        }

        $('.image-upload-wrap').bind('dragover', function () {
            $('.image-upload-wrap').addClass('image-dropping'); // Dragging davomida klass qo'shish
        });
        $('.image-upload-wrap').bind('dragleave', function () {
            $('.image-upload-wrap').removeClass('image-dropping'); // Dragging tugagach klassni olib tashlash
        });
    </script>

    <!-- Fayl yuklash uchun funksiya -->
    <script>
        document.getElementById('customFile').addEventListener('change', function (e) {
            var file = e.target.files[0];
            if (file) {
                var fileName = file.name;
                var fileType = fileName.split('.').pop();
                if (fileType === 'pdf' || fileType === 'doc' || fileType === 'docx') {
                    document.getElementById('fileInfo').innerHTML = 'Fayl nomi: ' + fileName; // Fayl nomini ko'rsatish
                } else {
                    document.getElementById('fileInfo').innerHTML = 'Faqat PDF va Word formatlarini tanlang.'; // Xato habarini ko'rsatish
                }
            }
        });
    </script>

    <!-- Inputlarni to'ldirish uchun funksiya -->
    <script>
        $(document).ready(function () {
            // BBK ma'lumotlarini olish uchun AJAX so'rovini yuborish
            $.ajax({
                url: '{% url "get_all_bbks" %}', // Django URL manzilini mos ravishda o'zgartiring
                type: 'GET',
                success: function (bbkData) {
                    var bbkSelect = $('#bbk-book');
                    bbkSelect.empty(); // Eski ma'lumotlarni tozalash

                    // "Tanlang..." qiymatini qo'shish
                    var defaultOption = new Option('BBKni tanlang', '');
                    bbkSelect.append(defaultOption);

                    // Tanlov ro'yxatini "select2" bilan to'ldirish
                    var bbks = bbkData.bbks;
                    for (var j = 0; j < bbks.length; j++) {
                        var bbkOption = new Option(bbks[j].title + ' | ' + bbks[j].name, bbks[j].id, false, false);
                        bbkSelect.append(bbkOption);
                    }

                    // select2 pluginini tanlangan select elementiga qo'llash
                    bbkSelect.prop('disabled', false);
                    bbkSelect.select2();
                },
                error: function (error) {
                    console.error('BBK-larni olishda xatolik:', error);
                }
            });

            // BBK-ni tanlandikda kitob turi ma'lumotlarini olish uchun AJAX so'rovini yuborish va formani ko'rsatish
            $('#bbk-book').change(function () {
                var selectedBBK = $(this).val();
                if (selectedBBK) {
                    $.ajax({
                        url: '{% url "get_all_book_types" %}', // URLni to'g'ri yo'naltirish kerak
                        type: 'GET',
                        success: function (response) {
                            var bookTypeSelect = $('#book-type-book');
                            bookTypeSelect.empty(); // Eski ma'lumotlarni tozalash

                            // "Tanlang..." qiymatini qo'shish
                            var defaultOption = new Option('Tanlang...', '');
                            bookTypeSelect.append(defaultOption);

                            // Tanlov ro'yxatini "select2" bilan to'ldirish
                            var bookTypes = response.book_types;
                            for (var i = 0; i < bookTypes.length; i++) {
                                var bookTypeOption = new Option(bookTypes[i].name, bookTypes[i].id, false, false);
                                bookTypeSelect.append(bookTypeOption);
                            }

                            // select2 pluginini tanlangan select elementiga qo'llash
                            bookTypeSelect.prop('disabled', false);
                            bookTypeSelect.select2();

                            // Formani ko'rsatish
                            $('#add-book-form-class').removeClass('d-none');
                        },
                        error: function (error) {
                            console.error('Book types ma\'lumotlarini olishda xatolik:', error);
                        }
                    });
                }
            });
        });
    </script>


    <!-- Plugins JS start-->

    <script src="{% static 'assets/js/owlcarousel/owl.carousel.js' %}"></script>
    <script src="{% static 'assets/js/owlcarousel/owl-custom.js' %}"></script>
    <script src="{% static 'assets/js/select2/select2.full.min.js' %}"></script>
    <script src="{% static 'assets/js/select2/select2-custom.js' %}"></script>
    <script src="{% static 'assets/js/dropzone/dropzone.js' %}"></script>
    <script src="{% static 'assets/js/dropzone/dropzone-script.js' %}"></script>
    <script src="{% static 'assets/js/tooltip-init.js' %}"></script>
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.js' %}"></script>
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.en.js' %}"></script>
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.custom.js' %}"></script>

    <!-- Plugins JS Ends-->
{% endblock %}