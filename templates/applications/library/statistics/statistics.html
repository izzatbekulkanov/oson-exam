{% extends 'base.html' %}

{% load static %}
{% load sass_tags %}
{% block css %}
    <!-- Plugins css start-->

    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/date-picker.scss' %}">
    <!-- Plugins css Ends-->
{% endblock %}

{% block content %}

    <div class="page-body">
        <div class="container-fluid">
            {% include "layout/breadcrumb.html" %}
            <div class="row">
                {% include "applications/library/statistics/components/visitors.html" %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scriptcontent %}



    <!-- Plugins JS start-->
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.js' %}"></script>
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.en.js' %}"></script>
    <script src="{% static 'assets/js/datepicker/date-picker/datepicker.custom.js' %}"></script>

    
<script>
    $(document).ready(function () {
        // Function to fetch data and populate table
        fetchDataAndPopulateTable();

        // Click event handler for download button
        $('#downloadBtn').click(function () {
            // Generate Word file
            generateWordFile();
        });

        function fetchDataAndPopulateTable() {
            $.ajax({
                url: '{% url 'library_stats_by_language' %}',  // Replace with your Django view URL
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    // Populate table with fetched data
                    populateTable(data);
                },
                error: function (xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText); // Log error to console
                    alert('Error fetching data. Please try again.');  // Show error to user
                }
            });
        }

        function populateTable(data) {
            var languages = data.languages;
            var stats = data.data;
            var tableBody = $('#library-stats-body');
            tableBody.empty(); // Clear existing table rows

            // Loop through fetched data and populate table rows
            $.each(stats, function (index, bookType) {
                var row = '<tr>';
                row += '<td class="text-center">' + (index + 1) + '</td>';
                row += '<td class="text-center">' + bookType.name + '</td>';

                // Loop through languages
                $.each(languages, function (_, language) {
                    var langStats = bookType.languages[language];
                    row += '<td class="text-center">' + langStats.original_books_count + '</td>';
                    row += '<td class="text-center">' + langStats.book_copies_count + '</td>';
                });

                // Add totals for each book type
                row += '<td class="text-center">' + bookType.total_original_books + '</td>';
                row += '<td class="text-center">' + bookType.total_book_copies + '</td>';
                row += '</tr>';

                tableBody.append(row); // Append row to table body
            });

            // Add total row at the bottom of the table
            var totalRow = '<tr>';
            totalRow += '<td colspan="2" class="text-center font-weight-bold">Jami</td>';

            var grandTotalOriginalBooks = 0;
            var grandTotalBookCopies = 0;

            // Loop through languages to calculate grand totals
            $.each(languages, function (_, language) {
                var totalOriginalBooksForLanguage = 0;
                var totalBookCopiesForLanguage = 0;

                // Loop through stats to sum up totals for each language
                $.each(stats, function (_, bookType) {
                    var langStats = bookType.languages[language];
                    totalOriginalBooksForLanguage += langStats.original_books_count;
                    totalBookCopiesForLanguage += langStats.book_copies_count;
                });

                // Add language totals to grand totals
                grandTotalOriginalBooks += totalOriginalBooksForLanguage;
                grandTotalBookCopies += totalBookCopiesForLanguage;

                // Append language totals to total row
                totalRow += '<td class="text-center">' + totalOriginalBooksForLanguage + '</td>';
                totalRow += '<td class="text-center">' + totalBookCopiesForLanguage + '</td>';
            });

            // Add grand totals to total row
            totalRow += '<td class="text-center">' + grandTotalOriginalBooks + '</td>';
            totalRow += '<td class="text-center">' + grandTotalBookCopies + '</td>';
            totalRow += '</tr>';

            tableBody.append(totalRow); // Append total row to table body
        }

                // Function to generate Word file
        function generateWordFile() {
            // Fetch data and populate table
            $.ajax({
                url: '{% url 'library_stats_by_language' %}',  // Replace with your Django view URL
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    // Populate table with fetched data
                    populateTable(data);

                    // Generate Word file
                    var htmlContent = $('#library-stats-container').html();
                    var blob = new Blob([htmlContent], { type: 'application/msword' });

                    // Create a temporary anchor element to trigger the download
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'library_stats.doc';  // Filename for the downloaded file
                    link.click();
                },
                error: function (xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText); // Log error to console
                    alert('Error fetching data. Please try again.');  // Show error to user
                }
            });
        }
    });
</script>


    <!-- Plugins JS Ends-->
{% endblock %}