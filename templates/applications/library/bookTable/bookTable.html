{% extends 'base.html' %}

{% load static %}
{% load sass_tags %}
{% load i18n %}

{% block css %}
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">

    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/select2.scss' %}">

    <link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/sweetalert2.scss' %}">
    <!-- Plugins css Ends-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.css"/>


{% endblock %}


{% block content %}

    <div class="page-body">
        <div class="container-fluid">
            {% include "layout/breadcrumb.html" %}
            <div class="row">
                {% include "applications/library/bookTable/components/hover-table.html" %}
            </div>
        </div>
    </div>
    <div class="modal fade add_new_inventar" tabindex="-1" aria-labelledby="myLargeModalLabel" aria-hidden="true"
         style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel">Inventar raqam bo'yicha kitob qo'shish</h4>
                    <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body dark-modal">
                    <input type="hidden" id="kitob_id" value="">
                    <form class="row g-3" id="addInventoryNumberForm">
                        <div class="col-sm-12">
                            <label class="form-label bg-primary w-100 text-center" for="addBookCopyTitle"
                                   disabled="true">Kitob</label>
                            <input class="form-control" type="text" id="addBookCopyTitle" placeholder="Kitob nomi"
                                   aria-label="addBookCopyTitle">
                        </div>
                        <div class="col-sm-12 input-group">
                            <div class="col-sm-12">
                                <label class="form-label bg-primary w-100 text-center" for="book_name">Kitob inventar
                                    raqami</label>
                            </div>
                            <div class="col-sm-12 input-group mt-2">
                                <input class="form-control" type="text" id="inventory_number"
                                       placeholder="Inventar belgisi" aria-label="inventar">
                                <span class="input-group-text">-</span>
                                <input class="form-control" type="text" id="inventar_start"
                                       placeholder="Inventar raqami (START)" aria-label="inventarStart">
                                <span class="input-group-text">-</span>
                                <input class="form-control" type="text" id="inventar_end"
                                       placeholder="Inventar raqami (END)" aria-label="inventarEnd">
                            </div>
                            <div class="col-sm-12 mt-3 text-center">
                                <button class="btn btn-outline-success w-100" id="checkInventoryButton" type="button">
                                    <i class="icofont icofont-ui-search"></i> Inventarni tekshirish
                                </button>
                            </div>
                            <div class="col-sm-12 mt-3">
                                <label class="form-label bg-danger w-100 text-center d-none"
                                       id="alert-message-inventar">Qiymatni to'g'ri kiriting</label>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <p id="inventoryResult" class=" mt-3">Mavjud inventar raqamlari: <span></span></p>
                        </div>
                        <hr>
                        <div class="col-12">
                            <button id="saveButtonBookCopy" class="btn btn-success w-100 d-none" type="button">
                                <i class="icofont icofont-ui-save"></i> Saqlash
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal HTML kodi -->
    <div class="modal fade delete_new_inventar" tabindex="-1" aria-labelledby="myLargeModalLabel" aria-hidden="true"
         style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel">Kitob o'chirish</h4>
                    <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body dark-modal">
                    <!-- CHECKBOXES Row Starts-->
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-header">
                                <table>
                                    <tbody style="width: 100%">
                                    <tr>
                                        <td style="width: 40%">
                                            <span style="color: #52526C;opacity: 0.8;">Kitob nomi</span>
                                            <h6 id="delete_book_name" style="width: 46%">Kitob nomi bolishi kerak</h6>
                                        </td>
                                        <td style="text-align: left; width: 21%;">
                                            <span style="color: #52526C;opacity: 0.8; width: 21%">Kitob turi</span>
                                            <h6 id="delete_book_type">Kitob turi bolishi kerak</h6>
                                        </td>
                                        <td style="text-align: left; width: 21% ">
                                            <span style="color: #52526C;opacity: 0.8; width: 21%">BBK</span>
                                            <h6 id="delete_book_bbk">BBK bolishi kerak</h6>
                                        </td>
                                        <td style="text-align: left; width: 21% ">
                                            <span style="color: #52526C;opacity: 0.8; ">ISBN</span>
                                            <h6 id="delete_book_isbn">ISBN raqami</h6>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <div class="card-block row">
                                    <div class="col-sm-12 col-lg-12 col-xl-12">
                                        <div class="table-responsive">
                                            <table class="table table-bordered checkbox-td-width">
                                                <thead>
                                                <tr>
                                                    <th>Tr</th>
                                                    <th>Inventar raqam</th>
                                                    <th>Kutubxona</th>
                                                    <th>Mavjudligi</th>
                                                    <th>Yaratilgan sanasi</th>
                                                    <th>Tanlash</th>
                                                </tr>
                                                </thead>
                                                <tbody id="delete_inventory_list">
                                                <!-- Inventar ro'yxati to'ldiriladi -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                    <button type="button" id="confirm_delete_button" class="btn btn-primary">O'chirishni tasdiqlash
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade editbook_modal" tabindex="-1" aria-labelledby="myLargeModalLabel" aria-hidden="true"
         style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel">Kitobni Tahrirlash</h4>
                    <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body dark-modal">
                    <!-- Add a hidden input field to store the bookId -->
                    <input type="hidden" id="editBookId" value="">
                    <form class="row g-3">
                        <div class="col-sm-8">
                            <label class="form-label bg-primary w-100 text-center" for="book_name">Kitob nomi</label>
                            <input class="form-control" name="book_name" id="book_name" type="text"
                                   placeholder="Kitob nomi" aria-label="Book Name" required="">
                        </div>
                        <div class="col-md-4 col-sm-4">
                            <label class="form-label bg-primary w-100 text-center" for="author_code">Muallif
                                kodi</label>
                            <input class="form-control" name="author_code" id="author_code-name" type="text"
                                   placeholder="Author code" aria-label="Muallif kodi" required="">
                        </div>
                        <div class="col-sm-12">
                            <label class="form-label bg-primary w-100 text-center" for="authors_name">Kitob
                                mualliflari</label>
                            <select class="form-control select2" id="authors_name" multiple="multiple"
                                    style="width: 100%;">
                                <!-- Bu yerga AJAX orqali olingan mualliflar qo'shiladi -->
                            </select>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <label class="form-label bg-primary w-100 text-center" for="state-1">Kitob turi</label>
                            <select class="form-select" id="state-1" required="">
                                <option selected="" disabled="" value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <label class="form-label bg-primary w-100 text-center" for="state-2">BBK</label>
                            <select class="form-select" id="state-2" required="">
                                <option selected="" disabled="" value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <label class="form-label bg-primary w-100 text-center" for="state-3">Kitob tili</label>
                            <select class="form-select" id="state-3" required="">
                                <option selected="" disabled="" value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-sm-12">
                            <div class="form-group" id="book_file_link"></div>
                            <div class="file-upload" id="book_file_upload">
                                <label class="form-label bg-info w-100 text-center" for="formFile1">Kitob faylini
                                    tanlang</label>
                                <input class="form-control" id="formFile1" type="file" accept="application/pdf"
                                       aria-label="file example">
                                <div class="invalid-feedback">Invalid form file selected</div>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-12">
                            <div class="form-group" id="book_image_link"></div>
                            <div class="file-upload" id="book_image_upload">
                                <label class="form-label bg-info w-100 text-center" for="formFile2">Kitob rasmini
                                    tanlang</label>
                                <input class="form-control" id="formFile2" type="file" accept="image/*"
                                       aria-label="file example">
                                <div class="invalid-feedback">Invalid form file selected</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-success w-100">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scriptcontent %}
    <script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="{% static 'assets/js/tooltip-init.js' %}"></script>


    <!-- Plugins JS Ends-->



    <script>
        $(document).ready(function () {
            // Book type olish va selectni to'ldirish
            $.ajax({
                url: '{% url "get_all_book_types" %}',
                method: 'GET',
                success: function (data) {
                    populateBookTypeSelect2(data.book_types, 'state-1');
                },
                error: function (xhr, status, error) {
                    console.error('Failed to fetch book types:', error);
                }
            });

            // Fetch and populate BBKs
            $.ajax({
                url: '{% url "get_all_bbks" %}',
                method: 'GET',
                success: function (data) {
                    populateBbkSelect2(data.bbks, 'state-2');
                },
                error: function (xhr, status, error) {
                    console.error('Failed to fetch BBKs:', error);
                }
            });

            function populateBbkSelect2(options, selectId) {
                var select = $('#' + selectId);
                if (!select.length) {
                    console.error('selectId ' + selectId + ' uchun tanlov elementi topilmadi.');
                    return;
                }

                var selectOptions = [{id: '', text: 'Tanlang...'}];
                $.each(options, function (index, item) {
                    selectOptions.push({id: item.id, text: item.title + ' | ' + item.name});
                });

                select.select2({
                    placeholder: "Tanlang",
                    allowClear: true,
                    data: selectOptions
                });
            }

            function populateBookTypeSelect2(options, selectId) {
                var select = $('#' + selectId);
                if (!select.length) {
                    console.error('selectId ' + selectId + ' uchun tanlov elementi topilmadi.');
                    return;
                }

                var selectOptions = [{id: '', text: 'Tanlang...'}];
                $.each(options, function (index, item) {
                    selectOptions.push({id: item.id, text: item.name});
                });

                select.select2({
                    placeholder: "Tanlang",
                    allowClear: true,
                    data: selectOptions
                });
            }
        });
    </script>

    <script>
        // Til selectini to'ldirish
        document.addEventListener('DOMContentLoaded', function () {
            const languageChoices = [
                ['en', 'Ingliz'],
                ['tr', 'Turk'],
                ['fr', 'Fransuz'],
                ['uz', "O'zbek (lotin)"],
                ['oz', "O'zbek (kril)"],
                ['ru', 'Rus'],
                ['de', 'Nemis'],
                ['zh', 'Xitoy'],
                ['es', 'Ispan'],
                ['ko', 'Koreys'],
                ['kk', 'Qozoq'],
                ['ky', 'Qirg\'iz'],
                ['tg', 'Tojik'],
                ['qr', 'Qoraqalpoq']
            ];

            const languageSelect = document.getElementById('state-3');
            languageChoices.forEach(function (choice) {
                const option = document.createElement('option');
                option.value = choice[0];
                option.textContent = choice[1];
                languageSelect.appendChild(option);
            });
        });
    </script>

   <script>
    $(document).ready(function () {
        // Initialize Select2 on the authors select element
        $('#authors_name').select2({
            placeholder: 'Mualliflarni tanlang...',
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: '{% url "authors_list" %}',  // URL for AJAX request
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term  // Search query
                    };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data, function (item) {
                            return {
                                id: item.id,
                                text: item.name
                            };
                        })
                    };
                },
                cache: true
            }
        });
    
        // When the edit modal is shown
        $('.editbook_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var bookId = button.data('id'); // Extract info from data-* attributes
            $('#editBookId').val(bookId); // Store bookId in hidden input
    
            // Fetch and populate selected authors
            if (bookId) {
                $.ajax({
                    url: '{% url "get_book_authors" %}',  // URL to get book authors
                    type: 'GET',
                    data: { book_id: bookId },
                    success: function (response) {
                        var selectedAuthors = response.authors;
                        var authorOptions = [];
    
                        $.each(selectedAuthors, function (index, author) {
                            var option = new Option(author.name, author.id, true, true);
                            authorOptions.push(option);
                        });
    
                        $('#authors_name').empty().append(authorOptions).trigger('change');
                    },
                    error: function (xhr, status, error) {
                        console.error('Mualliflarni olishda xatolik:', error);
                    }
                });
            }
        });
    
        // Handle form submission
        $('.editbook_modal .btn-success').on('click', function (event) {
            event.preventDefault(); // Prevent the form from submitting
            
            var bookId = $('#editBookId').val(); // Retrieve the stored bookId
            console.log(bookId);
            // Add your form submission code here
        });
    });
    </script>

    <script>
        $(document).ready(function () {
            // Select2 ni o'rnatish
            $('#filterStatus, #filterFile').select2({
                placeholder: "Tanlang", // placeholder matn
                allowClear: true, // o'chirish tugmasini yoqish
            });

            function populateSelect2BBK(url, selectId) {
                var select = $('#' + selectId);
                if (!select.length) {
                    console.error('selectId ' + selectId + ' uchun tanlov elementi topilmadi.');
                    return;
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var options = [{id: '', text: ''}];
                        $.each(data.bbks, function (index, item) {
                            options.push({id: item.id, text: item.name});
                        });
                        select.select2({
                            placeholder: "Tanlang",
                            allowClear: true,
                            data: options
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Ma\'lumotlar olishda xatolik yuz berdi:', error);
                    }
                });
            }

            function populateSelect2BookType(url, selectId) {
                var select = $('#' + selectId);
                if (!select.length) {
                    console.error('selectId ' + selectId + ' uchun tanlov elementi topilmadi.');
                    return;
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var options = [{id: null, text: ''}];
                        $.each(data.book_types, function (index, item) {
                            options.push({id: item.id, text: item.name});
                        });
                        select.select2({
                            placeholder: "Tanlang",
                            allowClear: true,
                            data: options
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Ma\'lumotlar olishda xatolik yuz berdi:', error);
                    }
                });
            }

            function fillSelect2BBK() {
                var url = '{% url 'get_all_bbks' %}';
                var selectId = 'filterBBKSelect';
                populateSelect2BBK(url, selectId);
            }

            function fillSelect2BookType() {
                var url = '{% url 'get_all_book_types' %}';
                var selectId = 'filterBookType';
                populateSelect2BookType(url, selectId);
            }

            fillSelect2BBK();
            fillSelect2BookType();
        });
    </script>

    <script>
        // jadvalni to'ldirish uchun funksiya
        var table = $('#example-style-4').DataTable();

        // Filter books function to filter and update table
        function filterBooks() {
            var filters = {
                book_type: $('#filterBookType').val(),
                bbk: $('#filterBBKSelect').val(),
                status: $('#filterStatus').val(),
                file: $('#filterFile').val()
            };

            $.ajax({
                url: '{% url "filter_books" %}',
                data: filters,
                success: function (response) {
                    updateTable(response.books);
                },
                error: function (xhr, status, error) {
                    console.error('Ajax request error:', error);
                }
            });
        }

        // Update DataTable with new data
        function updateTable(books) {
            table.clear();
            books.forEach(function (book, index) {
                var statusLabel = book.status === 'distributed' ? 'Tarqatilgan' : 'Tarqatilmagan';
                var fileLink = book.file ? `<a class="pdf" href="${book.file}" target="_blank"><i class="icofont icofont-file-pdf"></i></a>` : '<i class="icofont icofont-not-allowed text-danger"></i>';
                var row = [
                    index + 1,
                    `<a href="#" class="ml-3">${book.title}</a>`,
                    book.book_type,
                    `${book.quantity} ta`,
                    book.bbk,
                    book.authors,
                    book.authors_code,
                    fileLink,
                    book.language,
                    `<span class="badge rounded-pill badge-${book.status === 'distributed' ? 'success' : 'danger'}">${statusLabel}</span>`,
                    book.created_at,
                    createActionButtons(book.id)
                ];
                table.row.add(row);
            });
            table.draw(false);
            // Attach edit handlers after updating the table
            attachEditHandlers();
        }

        // Attach click event handler to the edit buttons
        function attachEditHandlers() {
            $('.edit-book').on('click', function () {
                var bookId = $(this).data('id');
                fetchBookDetails(bookId);
            });
        }

        // Function to create action buttons for each row
        function createActionButtons(bookId) {
            return `
            <ul class="action">
                <li class="delete">
                    <button class="edit-book btn btn-primary" data-bs-toggle="modal" data-id="${bookId}" data-bs-target=".editbook_modal">
                        <i class="icon-pencil-alt text-white"></i>
                    </button>
                </li>
                <li class="delete">
                    <button class="btn btn-success" id="btn-successs" data-bs-toggle="modal" data-id="${bookId}" data-bs-target=".add_new_inventar">
                        <i class="icofont icofont-ui-add text-white"></i>
                    </button>
                </li>
                <li class="delete">
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target=".delete_new_inventar">
                        <i class="icofont icofont-ui-delete text-white"></i>
                    </button>
                </li>
            </ul>
        `;
        }

        // Attach click event handler to the edit buttons
        $(document).on('click', '.edit-book', function () {
            var bookId = $(this).data('id');
            fetchBookDetails(bookId);
        });

        // Fetch book details and display in modal
        function fetchBookDetails(bookId) {
            $.ajax({
                url: '{% url "get_book_details" %}',
                data: {book_id: bookId},
                success: function (response) {
                    populateModal(response, bookId); // Pass bookId to populateModal
                    $('.editbook_modal').modal('show');
                },
                error: function (xhr, status, error) {
                    console.error('Ajax request error:', error);
                }
            });
        }

        // Populate modal with book details and store bookId
        function populateModal(book, bookId) {
            $('#book_name').val(book.title);
            $('#author_code-name').val(book.author_code);
            $('#state-1').val(book.book_type_id).trigger('change');
            $('#state-2').val(book.bbk_id).trigger('change');
            $('#state-3').val(book.language_id).trigger('change');
            $('#editBookId').val(bookId); // Store bookId in a hidden input field

            $('#book_file_link').html(book.file ? `<a href="${book.file}" class="text-center bg-primary text-white p-2">Kitob Fayli</a>` : '');
            $('#book_image_link').html(book.image ? `<a href="${book.image}" class="text-center bg-primary text-white p-2">Kitob Rasmi</a>` : '');
        }

        // Attach click event handler to the filter button and filter selects
        $('#filterButton').on('click', filterBooks);
        $('.filter-select').on('change', filterBooks);

        // Initial load
        filterBooks();

        // Save button click event handler
        $('.editbook_modal .btn-success').on('click', function (event) {
            event.preventDefault(); // Prevent the form from submitting
            var bookId = $('#editBookId').val(); // Retrieve the stored bookId
            updateBookDetails(bookId);
        });


        // Kitob tafsilotlarini yangilash
        function updateBookDetails(bookId) {
            console.log("kitob id:", bookId);
            
            // Collecting form data
            var updatedData = {
                book_id: bookId,
                title: $('#book_name').val(),
                authorCode: $('#author_code-name').val(),
                book_type_id: $('#state-1').val(),
                bbk_id: $('#state-2').val(),
                language_id: $('#state-3').val(),
                file: $('#formFile1')[0].files[0], // Kitob fayli uchun file input id
                image: $('#formFile2')[0].files[0] // Kitob rasmi uchun file input id
            };
        
            // Collecting selected authors
            var selectedAuthors = $('#authors_name').val();
        
            var formData = new FormData();
            for (var key in updatedData) {
                formData.append(key, updatedData[key]);
            }
        
            // Append selected authors to formData
            formData.append('authors', JSON.stringify(selectedAuthors));
        
            // CSRF tokenni FormData ga qo'shish
            var csrfToken = getCSRFToken();
            formData.append('csrfmiddlewaretoken', csrfToken);
        
            // AJAX so'rovi orqali kitob tafsilotlarini yangilash
            $.ajax({
                url: '{% url "update_book_details" %}', // O'zingizning URL ni kiriting
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': csrfToken  // CSRF tokenni header ga qo'shish
                },
                success: function (response) {
                    // Muvaffaqiyatli yangilanishdan keyin bajarilishi mumkin bo'lgan harakatlar
                    console.log(response);
                    $('.editbook_modal').modal('hide');
                    var myNotify = new Notify({
                        position: "right bottom",
                        status: 'success',
                        title: "{% trans 'library' %}",
                        text: response.message,
                        autotimeout: 3000,
                        speed: 200,
                        autoclose: true,
                        effect: 'slide',
                        type: 'outline'
                    });
                    filterBooks();
                },
                error: function (xhr, status, error) {
                    console.error('Ajax so\'rov xatosi:', error);
                }
            });
        }
    </script>

    <script>
        // Delete tugmasi bosilganda bo'ladigan holatar
        $(document).ready(function () {
            var deleteBookId; // Variable to store the ID of the book to be deleted
            var currentBook; // Variable to store the current book object

            // Click event handler for the delete button
            $(document).on('click', '.btn-danger', function () {
                deleteBookId = $(this).closest('tr').find('.edit-book').data('id'); // Get the book ID
                fetchBookDetailsForDeletion(deleteBookId); // Fetch details for deletion
            });

            // Function to fetch book details for deletion via AJAX
            function fetchBookDetailsForDeletion(bookId) {
                $.ajax({
                    url: '{% url "get_book_details" %}', // Replace with your actual URL to fetch book details
                    method: 'GET',
                    data: {book_id: bookId},
                    success: function (response) {
                        currentBook = response; // Set the current book object
                        populateDeleteModal(currentBook); // Populate modal with fetched book details
                        $('.delete_new_inventar').modal('show'); // Show the modal
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching book details:', error);
                        let errorMessage = 'Error fetching book details';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            errorMessage = xhr.responseText;
                        }
                        alert(errorMessage);
                    }
                });
            }

            // Function to populate the delete modal with book details
            function populateDeleteModal(book) {
                $('#delete_book_name').text(book.title);
                $('#delete_book_type').text(book.book_type);
                $('#delete_book_bbk').text(book.bbk_code + " | " + book.bbk);
                $('#delete_book_isbn').text(book.isbn);

                // Populate inventory list
                var inventoryList = '';
                book.copies.forEach(function (copy, index) {
                    var libraryBadge = copy.library
                        ? `<span class="badge badge-success">${copy.library}</span>`
                        : '<span class="badge badge-danger">Not Collected</span>';

                    inventoryList += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${copy.inventory_number}</td>
                    <td>${libraryBadge}</td>
                    <td>${copy.haveStatus}</td>
                    <td>${copy.created_at}</td>
                    <td>
                        <div class="checkbox checkbox-dark">
                            <input id="checkbox-${index}" type="checkbox" data-copy-id="${copy.id}">
                            <label for="checkbox-${index}">Select</label>
                        </div>
                    </td>
                </tr>
            `;
                });

                $('#delete_inventory_list').html(inventoryList); // Set inventory list in modal
            }

            // Click event handler for the confirm delete button
            $(document).on('click', '#confirm_delete_button', function () {
                deleteBookCopy(deleteBookId);
            });

            // Function to delete selected book copies via AJAX
            function deleteBookCopy(bookId) {
                // Ensure currentBook object is available
                if (!currentBook) {
                    console.error('No book details available.');
                    return;
                }

                var selectedCopies = [];
                $('#delete_inventory_list input[type="checkbox"]:checked').each(function () {
                    var copyId = $(this).data('copy-id');
                    selectedCopies.push(copyId); // Push selected copy IDs
                });

                console.log(selectedCopies)

                // Ensure that at least one copy is selected
                if (selectedCopies.length === 0) {
                    alert('Please select at least one book copy to delete.');
                    return;
                }

                // Send AJAX request to delete book copies
                $.ajax({
                    url: '{% url "delete_book_copies" %}', // Replace with your actual delete endpoint URL
                    method: 'POST',
                    data: {
                        book_id: bookId,
                        copies: selectedCopies,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    traditional: true, // Ensure jQuery sends arrays correctly
                    success: function (response) {
                        if (response.success) {
                            {#alert(`${response.message}`);#}
                            filterBooks();
                            $('.delete_new_inventar').modal('hide'); // Hide the modal
                            var myNotify = new Notify({
                                position: "right bottom",
                                status: 'success',
                                title: "{% trans 'library' %}",
                                text: response.message,
                                autotimeout: 3000,
                                speed: 200,
                                autoclose: true,
                                effect: 'slide',
                                type: 'outline'
                            });


                        } else {
                            alert('Error deleting book copies: ' + (response.error || 'An unknown error occurred'));
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error deleting book copies:', error);
                        let errorMessage = 'Error deleting book copies';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        } else if (xhr.responseText) {
                            errorMessage = xhr.responseText;
                        }
                        alert(errorMessage);
                    }
                });
            }
        });
    </script>

    <script>
        // Attach click event handler to the add new inventar button
        $(document).on('click', '#btn-successs', function () {
            var bookId = $(this).data('id');
            fetchBookDetailsForInventar(bookId);
        });

        // Function to fetch book details for inventar via AJAX
        function fetchBookDetailsForInventar(bookId) {
            $.ajax({
                url: '{% url "get_book_details" %}', // Replace with your actual URL to fetch book details
                method: 'GET',
                data: {book_id: bookId}, // Pass the book ID stored in the hidden input
                success: function (response) {
                    console.log(response);
                    populateInventarModal(response); // Populate modal with fetched book details
                    $('.add_new_inventar').modal('show'); // Show the modal
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching book details:', error);
                    let errorMessage = 'Error fetching book details';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                    alert(errorMessage);
                }
            });
        }

        // Function to populate the inventar modal with book details
        function populateInventarModal(book) {
            $('#addBookCopyTitle').val(book.title); // Populate book title
            // You can populate other fields as needed, e.g., inventory number, etc.
            $('#kitob_id').val(book.id); // Populate hidden field with book ID
        }

        $(document).ready(function () {
            // "Inventarni tekshirish" tugmasi bosilganda
            $('#checkInventoryButton').click(function () {
                var kitob_id = $('#kitob_id').val(); // kitob_id ni olish
                var inventory_number = $('#inventory_number').val(); // inventar number ni olish
                var inventar_start = $('#inventar_start').val(); // inventar start raqamini olish
                var inventar_end = $('#inventar_end').val(); // inventar end raqamini olish

                // start va end raqamlarini solishtirish
                if (inventar_start.length === inventar_end.length && parseInt(inventar_start) > parseInt(inventar_end)) {
                    $('#alert-message-inventar').removeClass('d-none').text('Inventar end raqami inventar start raqamidan kichik bo\'lishi mumkin emas.');
                    $('#inventar_end').val(''); // Notog'ri qiymatni o'chirish
                    $('#inventar_end').css('border', '2px solid red'); // Border qizil qilish
                    return; // Formani yuborishni to'xtatish
                } else {
                    $('#alert-message-inventar').addClass('d-none');
                    $('#inventar_end').css('border', ''); // Qizil borderni olib tashlash
                }

                // AJAX so'rovi yuborish
                $.ajax({
                    url: '{% url "check_inventory_existence" %}',
                    method: 'GET',
                    data: {
                        kitob_id: kitob_id,
                        inventory_number: inventory_number,
                        inventar_start: inventar_start,
                        inventar_end: inventar_end
                    },
                    success: function (response) {
                        console.log(response);
                        // Natijani qabul qilish va ma'lumotlarni ishlovchi funksiyani chaqirish
                        processInventoryResponse(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Xatolik:', error);
                        {#alert('Inventar raqamlarini tekshirishda xatolik yuz berdi. Iltimos, qayta urinib ko\'ring.');#}
                    }
                });
            });

            // "inventar_end" o'zgarganda tekshiruv
            $('#inventar_end').on('input', function () {
                var inventar_start = $('#inventar_start').val();
                var inventar_end = $(this).val();

                if (inventar_start.length === inventar_end.length && parseInt(inventar_start) > parseInt(inventar_end)) {
                    $('#alert-message-inventar').removeClass('d-none').text('Inventar end raqami inventar start raqamidan kichik bo\'lishi mumkin emas.');
                    $(this).val(''); // Notog'ri qiymatni o'chirish
                    $(this).css('border', '2px solid red'); // Border qizil qilish
                } else {
                    $('#alert-message-inventar').addClass('d-none');
                    $(this).css('border', ''); // Qizil borderni olib tashlash
                }
            });

            // Serverdan qaytgan ma'lumotlarni ishlovchi funksiya
            function processInventoryResponse(response) {
                if (response.exists_inventories && Array.isArray(response.exists_inventories)) {
                    var existsInventories = response.exists_inventories.join(' | '); // Ma'lumotlarni vergul bilan ajratib chiqish
                    $('#inventoryResult').text('Mavjud inventar raqamlari: ' + existsInventories);
                } else {
                    $('#inventoryResult').text('').add('d-none').removeClass('mt-3');
                    console.log('bu yerda ham menman')
                    $('#saveButtonBookCopy').removeClass('d-none');
                    $('#alert-message-inventar').removeClass('d-none bg-danger border').addClass('bg-success').text('Mavjud inventar kiritish uchun yaroqli'); // No inventories found message
                    {#$('#inventoryResult').text('Mavjud inventar raqamlari topilmadi'); #}
                }
            }
        });

        // Formani tozalash funksiyasi
        function clearForm() {
            $('#addBookCopyTitle').val('');
            $('#inventory_number').val('');
            $('#inventar_start').val('');
            $('#inventar_end').val('');
            $('#inventoryResult span').text('');
        }

        // Saqlash tugmasi bosilganda
        $('#saveButtonBookCopy').click(function () {
            var kitob_id = $('#kitob_id').val(); // Kitob ID'sini yashirin maydondan olish
            var inventory_number = $('#inventory_number').val(); // Inventar belgisi
            var inventar_start = $('#inventar_start').val(); // Boshlang'ich inventar raqami
            var inventar_end = $('#inventar_end').val(); // Tugash inventar raqami

            // Kiritilgan maydonlarni tekshirish (hamma kerakli maydonlar to'ldirilganligini tekshirish)
            if (!kitob_id || !inventory_number || !inventar_start || !inventar_end) {
                alert('Iltimos, barcha kerakli maydonlarni to\'ldiring.');
                return;
            }

            // Foydalanuvchidan tasdiq olish
            Swal.fire({
                title: "Bu kitob nusxalarini saqlamoqchimisiz?",
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: "Saqlash",
                denyButtonText: `Saqlamayman`
            }).then((result) => {
                if (result.isConfirmed) {
                    // Formani ma'lumotlarini tayyorlash
                    var formData = new FormData();
                    formData.append('kitob_id', kitob_id);
                    formData.append('inventory_number', inventory_number);
                    formData.append('inventar_start', inventar_start);
                    formData.append('inventar_end', inventar_end);

                    // CSRF tokenni FormData ga qo'shish
                    var csrfToken = getCSRFToken();
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // AJAX so'rovi orqali kitob nusxalarini saqlash
                    $.ajax({
                        url: '{% url "save_book_copies" %}', // URL ni o'zgartiring
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'X-CSRFToken': csrfToken  // CSRF tokenni header ga qo'shish
                        },
                        success: function (response) {
                            // Muvaffaqiyatli saqlanganidan keyin bajarilishi mumkin bo'lgan harakatlar
                            $('.add_new_inventar').modal('hide');
                            filterBooks();
                            Swal.fire("Saqlandi!", "", "success");
                            clearForm(); // Formani tozalash
                        },
                        error: function (xhr, status, error) {
                            filterBooks();
                            console.error('Kitob nusxalarini saqlashda xato:', error);
                            Swal.fire("Hatolik!", "", "error");
                        }
                    });
                } else if (result.isDenied) {
                    Swal.fire("O'zgarishlar saqlanmadi", "", "info");
                }
            });
        });
    </script>

    <script>
        // Function to get CSRF token from cookies
        function getCSRFToken() {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        };
    </script>
    <!-- Plugins JS start-->

    <script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>

    <script src="{% static 'assets/js/select2/select2.full.min.js' %}"></script>
    <script src="{% static 'assets/js/select2/select2-custom.js' %}"></script>

{% endblock %}