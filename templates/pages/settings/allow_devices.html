{% extends 'pages/base.html' %}
{% load static %}



{% block content %}
    <div class="app-content content ">
        <div class="content-overlay"></div>
        <div class="header-navbar-shadow"></div>
        <div class="content-wrapper container-xxl p-0">
            <div class="content-header row">
            </div>
            <div class="content-body">
                <div class="card">
                    <div class="row" id="table-hover-row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header col">
                                    <h4 class="card-title">Tarmoqga kirish uchun ruxsat berilgan qurilmalar</h4>
                                    <span>
                                        
                                    </span>
                                </div>
                                
                                <div class="card-body col">
                                    <div class="input-group">
                                        <input type="text" id="searchInput" class="form-control" placeholder="Ip Adress yoki Mac Adress orqali qidiring" aria-describedby="button-addon2">
                                        <button class="btn btn-outline-primary waves-effect" id="search_ip_or_mac_btn" type="button">Qidirish</button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table id="deviceTable" class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>TR</th>
                                                <th>ip_address</th>
                                                <th>mac_address</th>
                                                <th>manufacturer</th>
                                                <th>status</th>
                                                <th>Chekbox</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deviceTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock content %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    updateDevice();

   
    document.getElementById('search_ip_or_mac_btn').addEventListener('click', searchDevice);
});


function updateDevice() {
    fetch('{% url "allow_device_list" %}')
        .then(response => response.json())
        .then(data => {
            displayDevices(data.devices);
        })
        .catch(error => console.error('Qurilmalarni olishda xatolik:', error));
}

function displayDevices(devices) {
    const tableBody = document.getElementById('deviceTableBody');
    tableBody.innerHTML = "";

    devices.forEach((device, index) => {
        let badgeClass = "badge-light-primary";
        if (device.status === 'Tasdiqlangan') {
            badgeClass = "badge-light-success";
        } else if (device.status === 'Tasdiqlanmagan') {
            badgeClass = "badge-light-warning";
        } else if (device.status === 'Ta\'qiqlangan') {
            badgeClass = "badge-light-danger";
        }

        const isChecked = device.status === 'Tasdiqlangan' ? 'checked' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${device.ip_address}</td>
            <td>${device.mac_address}</td>
            <td>${device.manufacturer}</td>
            <td><span class="badge rounded-pill ${badgeClass} me-1">${device.status}</span></td>
            <td>
                <div class="form-check form-check-success">
                    <input type="checkbox" class="form-check-input" id="colorCheck${index + 1}" ${isChecked} data-ip="${device.ip_address}" onchange="updateToDevice(this)">
                    <label class="form-check-label" for="colorCheck${index + 1}">Tanlang</label>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function searchDevice() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();

    fetch('{% url "allow_device_list" %}')
        .then(response => response.json())
        .then(data => {
            const filteredDevices = data.devices.filter(device => {
                return device.ip_address.toLowerCase().includes(searchInput) || 
                       device.mac_address.toLowerCase().includes(searchInput);
            });
            displayDevices(filteredDevices);
        })
        .catch(error => console.error('Qurilmalarni olishda xatolik:', error));
}

function updateToDevice(checkbox) {
    const ip_address = checkbox.getAttribute('data-ip');

    if (!ip_address) {
        console.error('IP manzil topilmadi');
        return;
    }

    fetch('{% url "update_device_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ ip_addresses: [ip_address] })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(data.message, 'Muvaffaqiyatli', {
                positionClass: 'toast-bottom-right'
            });
            updateDevice();
        } else {
            toastr.error(data.message, 'Xatolik', {
                positionClass: 'toast-bottom-right'
            });
        }
    })
    .catch(error => {
        console.error('Xatolik yuz berdi:', error);
        toastr.error('So\'rovni bajaramayapman. Iltimos, qayta urinib ko\'ring.', 'Xatolik', {
            positionClass: 'toast-bottom-right'
        });
    });
}
</script>

    <script>
    $(document).ready(function() {
        updateDevice();
        
    });
    </script>

{% endblock script %}
